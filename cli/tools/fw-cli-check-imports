#!/usr/bin/env bash
# fw-cli-check-imports
# wasm の import が許容集合に閉じているか検査し、監査レポートを出力する
#
# 使用法:
#   fw-cli-check-imports <component.wasm> --allowlist <allowlist.txt> --out <output.json>
#
# 依存:
#   - wasm-tools (https://github.com/bytecodealliance/wasm-tools)
#   - jq

set -euo pipefail

usage() {
  cat >&2 << EOF
Usage: $0 <component.wasm> --allowlist <allowlist.txt> --out <output.json>

Options:
  --allowlist  Path to allowlist file (one import per line)
  --out        Output JSON report path
  -h,--help    Show this help
EOF
  exit 1
}

WASM_FILE=""
ALLOWLIST=""
OUTPUT_JSON=""

while [[ $# -gt 0 ]]; do
  case "$1" in
    --allowlist)
      ALLOWLIST="$2"
      shift 2
      ;;
    --out)
      OUTPUT_JSON="$2"
      shift 2
      ;;
    -h|--help)
      usage
      ;;
    *)
      if [[ -z "$WASM_FILE" ]]; then
        WASM_FILE="$1"
      else
        echo "Error: Unknown argument: $1" >&2
        usage
      fi
      shift
      ;;
  esac
done

if [[ -z "$WASM_FILE" ]] || [[ -z "$ALLOWLIST" ]] || [[ -z "$OUTPUT_JSON" ]]; then
  usage
fi

if [[ ! -f "$WASM_FILE" ]]; then
  echo "Error: $WASM_FILE not found" >&2
  exit 1
fi

if [[ ! -f "$ALLOWLIST" ]]; then
  echo "Error: $ALLOWLIST not found" >&2
  exit 1
fi

# Check dependencies
if ! command -v wasm-tools &> /dev/null; then
  echo "Error: wasm-tools command not found" >&2
  echo "Install it: cargo install wasm-tools" >&2
  exit 1
fi

if ! command -v jq &> /dev/null; then
  echo "Error: jq command not found" >&2
  exit 1
fi

mkdir -p "$(dirname "$OUTPUT_JSON")"

echo "Checking imports: $WASM_FILE"

# Extract imports from the component using wasm-tools component wit
# Parse lines like: import wasi:cli/environment@0.3.0-rc-2026-01-06;
IMPORTS_RAW=$(wasm-tools component wit "$WASM_FILE" 2>/dev/null \
  | grep -E '^\s*import\s+' \
  | sed -E 's/^\s*import\s+//' \
  | sed -E 's/\s*;.*$//' \
  | sed -E 's/\s+.*$//' \
  || true)

# Parse imports into array (filter empty lines)
mapfile -t IMPORTS < <(echo "$IMPORTS_RAW" | grep -v '^$' | sort -u)

# Read allowlist (filter comments and empty lines)
mapfile -t ALLOWED < <(grep -v '^$' "$ALLOWLIST" | grep -v '^#' | sort -u)

# Find extra imports (not in allowlist)
EXTRA=()
for imp in "${IMPORTS[@]}"; do
  [[ -z "$imp" ]] && continue
  found=0
  for allowed in "${ALLOWED[@]}"; do
    # Check if import matches or starts with allowed pattern
    if [[ "$imp" == "$allowed" ]]; then
      found=1
      break
    fi
  done
  if [[ $found -eq 0 ]]; then
    EXTRA+=("$imp")
  fi
done

# Find missing imports (in allowlist but not used - informational only)
MISSING=()
for allowed in "${ALLOWED[@]}"; do
  [[ -z "$allowed" ]] && continue
  found=0
  for imp in "${IMPORTS[@]}"; do
    if [[ "$imp" == "$allowed" ]]; then
      found=1
      break
    fi
  done
  if [[ $found -eq 0 ]]; then
    MISSING+=("$allowed")
  fi
done

# Generate JSON arrays
imports_json="[]"
if [[ ${#IMPORTS[@]} -gt 0 ]]; then
  imports_json=$(printf '%s\n' "${IMPORTS[@]}" | grep -v '^$' | jq -R . | jq -s .)
fi

extra_json="[]"
if [[ ${#EXTRA[@]} -gt 0 ]]; then
  extra_json=$(printf '%s\n' "${EXTRA[@]}" | grep -v '^$' | jq -R . | jq -s .)
fi

missing_json="[]"
if [[ ${#MISSING[@]} -gt 0 ]]; then
  missing_json=$(printf '%s\n' "${MISSING[@]}" | grep -v '^$' | jq -R . | jq -s .)
fi

# Generate JSON report
cat > "$OUTPUT_JSON" << EOF
{
  "artifact": "$WASM_FILE",
  "allowlist": "$ALLOWLIST",
  "imports": $imports_json,
  "extra_imports": $extra_json,
  "missing_imports": $missing_json
}
EOF

echo "Generated: $OUTPUT_JSON"

# Report results
echo ""
echo "=== Import Check Results ==="
echo "Total imports: ${#IMPORTS[@]}"

if [[ ${#EXTRA[@]} -gt 0 ]]; then
  echo ""
  echo "WARNING: Found ${#EXTRA[@]} import(s) NOT in allowlist:"
  for e in "${EXTRA[@]}"; do
    echo "  - $e"
  done
  echo ""
  echo "FAILED: Component has imports outside the allowed set"
  exit 1
else
  echo "OK: All imports are within the allowlist"
  if [[ ${#MISSING[@]} -gt 0 ]]; then
    echo "Note: ${#MISSING[@]} allowed import(s) not used (this is fine)"
  fi
fi
