#!/usr/bin/env bash
# fw-cli-compose
# tool.toml から tool.wac を生成、または wac を呼び出して最終 tool.wasm を生成する
#
# 使用法:
#   fw-cli-compose init <tool.toml> --out <tool.wac>   # .wac テンプレート生成
#   fw-cli-compose build <tool.wac> --out <tool.wasm>  # wac compose 実行
#
# 依存:
#   - wac (https://github.com/bytecodealliance/wac)

set -euo pipefail

usage() {
  cat >&2 << EOF
Usage:
  $0 init <tool.toml> --out <tool.wac>   Generate .wac template from tool.toml
  $0 build <tool.wac> --out <tool.wasm>  Compose final wasm using wac

Options:
  --out     Output file path
  -h,--help Show this help
EOF
  exit 1
}

cmd_init() {
  local tool_toml=""
  local out_wac=""

  while [[ $# -gt 0 ]]; do
    case "$1" in
      --out)
        out_wac="$2"
        shift 2
        ;;
      *)
        if [[ -z "$tool_toml" ]]; then
          tool_toml="$1"
        fi
        shift
        ;;
    esac
  done

  if [[ -z "$tool_toml" ]] || [[ -z "$out_wac" ]]; then
    echo "Error: init requires <tool.toml> and --out <tool.wac>" >&2
    usage
  fi

  if [[ ! -f "$tool_toml" ]]; then
    echo "Error: $tool_toml not found" >&2
    exit 1
  fi

  mkdir -p "$(dirname "$out_wac")"

  # Parse tool.toml
  local package version
  package=$(grep -E '^package\s*=' "$tool_toml" | head -1 | sed 's/.*=\s*"\(.*\)"/\1/')
  version=$(grep -E '^version\s*=' "$tool_toml" | head -1 | sed 's/.*=\s*"\(.*\)"/\1/')

  # Extract WASI snapshot version
  local wasi_snapshot
  wasi_snapshot=$(grep -E '^wasi_snapshot\s*=' "$tool_toml" | head -1 | sed 's/.*=\s*"\(.*\)"/\1/')
  wasi_snapshot="${wasi_snapshot:-0.3.0-rc-2026-01-06}"

  # Extract commands
  local -a commands=()
  local -a packages=()
  local in_command=false
  local current_name="" current_pkg=""

  while IFS= read -r line; do
    if [[ "$line" =~ ^\[\[command\]\] ]]; then
      if [[ -n "$current_name" ]]; then
        commands+=("$current_name")
        packages+=("$current_pkg")
      fi
      in_command=true
      current_name=""
      current_pkg=""
    elif [[ "$line" =~ ^\[.*\] ]] && [[ ! "$line" =~ ^\[\[command\]\] ]]; then
      if [[ -n "$current_name" ]]; then
        commands+=("$current_name")
        packages+=("$current_pkg")
      fi
      in_command=false
      current_name=""
      current_pkg=""
    elif $in_command; then
      if [[ "$line" =~ ^name[[:space:]]*=[[:space:]]*\"(.*)\" ]]; then
        current_name="${BASH_REMATCH[1]}"
      elif [[ "$line" =~ ^package[[:space:]]*=[[:space:]]*\"(.*)\" ]]; then
        current_pkg="${BASH_REMATCH[1]}"
      fi
    fi
  done < "$tool_toml"
  # Don't forget last command
  if [[ -n "$current_name" ]]; then
    commands+=("$current_name")
    packages+=("$current_pkg")
  fi

  local package_wit="${package//:/-}"

  # Generate .wac file
  cat > "$out_wac" << EOF
package ${package}@${version:-0.1.0} targets fw:cli-runner/app;

// --------------------------------------------------------------------------
// 許容WASI import
// --------------------------------------------------------------------------

// filesystem
import filesystem-types: wasi:filesystem/types@${wasi_snapshot};
import filesystem-preopens: wasi:filesystem/preopens@${wasi_snapshot};

// random
import random: wasi:random/random@${wasi_snapshot};
import insecure: wasi:random/insecure@${wasi_snapshot};
import insecure-seed: wasi:random/insecure-seed@${wasi_snapshot};

// cli
import environment: wasi:cli/environment@${wasi_snapshot};
import exit: wasi:cli/exit@${wasi_snapshot};
import stdin: wasi:cli/stdin@${wasi_snapshot};
import stdout: wasi:cli/stdout@${wasi_snapshot};
import stderr: wasi:cli/stderr@${wasi_snapshot};
import terminal-input: wasi:cli/terminal-input@${wasi_snapshot};
import terminal-output: wasi:cli/terminal-output@${wasi_snapshot};
import terminal-stdin: wasi:cli/terminal-stdin@${wasi_snapshot};
import terminal-stdout: wasi:cli/terminal-stdout@${wasi_snapshot};
import terminal-stderr: wasi:cli/terminal-stderr@${wasi_snapshot};

// --------------------------------------------------------------------------
// 1) host-provider（WASI境界）
// --------------------------------------------------------------------------
let hostp = new fw:cli-host@1.0.0 {
  filesystem-types,
  filesystem-preopens,
  random,
  insecure,
  insecure-seed,
  environment,
  exit,
  stdin,
  stdout,
  stderr,
  terminal-input,
  terminal-output,
  terminal-stdin,
  terminal-stdout,
  terminal-stderr,
};

// --------------------------------------------------------------------------
// 2) plugins（サブコマンド）
// --------------------------------------------------------------------------
EOF

  for i in "${!commands[@]}"; do
    local cmd="${commands[$i]}"
    local pkg="${packages[$i]}"
    cat >> "$out_wac" << EOF
let ${cmd} = new ${pkg} {
  host: hostp.host,
  filesystem-types,
  filesystem-preopens,
  random,
  insecure,
  insecure-seed,
};

EOF
  done

  # Generate registry instantiation
  cat >> "$out_wac" << EOF
// --------------------------------------------------------------------------
// 3) registry（生成物）
// --------------------------------------------------------------------------
let reg = new ${package_wit}-registry@${version:-0.1.0} {
EOF

  for cmd in "${commands[@]}"; do
    echo "  ${cmd}: ${cmd}.command," >> "$out_wac"
  done

  cat >> "$out_wac" << EOF
};

// --------------------------------------------------------------------------
// 4) core（ルータ）— wasi:cli/run を export する
// --------------------------------------------------------------------------
let core = new fw:cli-core@1.0.0 {
  host: hostp.host,
  registry: reg.registry,
};

// 最終成果物は core の exports をそのまま外へ（wasi:cli/run が出る）
export core...;
EOF

  echo "Generated: $out_wac"
}

cmd_build() {
  local wac_file=""
  local out_wasm=""

  while [[ $# -gt 0 ]]; do
    case "$1" in
      --out)
        out_wasm="$2"
        shift 2
        ;;
      *)
        if [[ -z "$wac_file" ]]; then
          wac_file="$1"
        fi
        shift
        ;;
    esac
  done

  if [[ -z "$wac_file" ]] || [[ -z "$out_wasm" ]]; then
    echo "Error: build requires <tool.wac> and --out <tool.wasm>" >&2
    usage
  fi

  if [[ ! -f "$wac_file" ]]; then
    echo "Error: $wac_file not found" >&2
    exit 1
  fi

  if ! command -v wac &> /dev/null; then
    echo "Error: wac command not found" >&2
    echo "Install it: cargo install wac-cli" >&2
    exit 1
  fi

  mkdir -p "$(dirname "$out_wasm")"

  echo "Composing: $wac_file -> $out_wasm"
  wac compose -o "$out_wasm" "$wac_file"
  echo "Generated: $out_wasm"
}

# Main
if [[ $# -lt 1 ]]; then
  usage
fi

case "$1" in
  init)
    shift
    cmd_init "$@"
    ;;
  build)
    shift
    cmd_build "$@"
    ;;
  -h|--help)
    usage
    ;;
  *)
    echo "Error: Unknown command: $1" >&2
    usage
    ;;
esac
