#!/usr/bin/env bash
# fw-cli-gen-registry
# tool.toml からレジストリ WIT と wasm を生成する
#
# 使用法:
#   fw-cli-gen-registry <tool.toml> --out-wit <path> --out-wasm <path>
#
# オプション:
#   --out-wit   生成される registry.wit のパス
#   --out-wasm  生成される registry.wasm のパス
#
# 出力:
#   - registry.wit  (生成された registry の world)
#   - registry.wasm (生成された registry component)

set -euo pipefail

usage() {
  echo "Usage: $0 <tool.toml> --out-wit <path> --out-wasm <path>" >&2
  exit 1
}

TOOL_TOML=""
OUT_WIT=""
OUT_WASM=""

while [[ $# -gt 0 ]]; do
  case "$1" in
    --out-wit)
      OUT_WIT="$2"
      shift 2
      ;;
    --out-wasm)
      OUT_WASM="$2"
      shift 2
      ;;
    -h|--help)
      usage
      ;;
    *)
      if [[ -z "$TOOL_TOML" ]]; then
        TOOL_TOML="$1"
      else
        echo "Error: Unknown argument: $1" >&2
        usage
      fi
      shift
      ;;
  esac
done

if [[ -z "$TOOL_TOML" ]] || [[ -z "$OUT_WIT" ]] || [[ -z "$OUT_WASM" ]]; then
  usage
fi

if [[ ! -f "$TOOL_TOML" ]]; then
  echo "Error: $TOOL_TOML not found" >&2
  exit 1
fi

# Ensure output directories exist
mkdir -p "$(dirname "$OUT_WIT")"
mkdir -p "$(dirname "$OUT_WASM")"

# Parse tool.toml and extract package info
PACKAGE=$(grep -E '^package\s*=' "$TOOL_TOML" | head -1 | sed 's/.*=\s*"\(.*\)"/\1/')
VERSION=$(grep -E '^version\s*=' "$TOOL_TOML" | head -1 | sed 's/.*=\s*"\(.*\)"/\1/')

if [[ -z "$PACKAGE" ]]; then
  echo "Error: Could not parse package from $TOOL_TOML" >&2
  exit 1
fi

# Convert package name for WIT (example:tool -> example-tool)
PACKAGE_WIT="${PACKAGE//:/-}"

# Extract commands from [[command]] sections
COMMANDS=()
in_command_section=false
while IFS= read -r line; do
  if [[ "$line" =~ ^\[\[command\]\] ]]; then
    in_command_section=true
  elif [[ "$line" =~ ^\[.*\] ]] && [[ ! "$line" =~ ^\[\[command\]\] ]]; then
    in_command_section=false
  elif $in_command_section && [[ "$line" =~ ^name[[:space:]]*=[[:space:]]*\"(.*)\" ]]; then
    COMMANDS+=("${BASH_REMATCH[1]}")
  fi
done < "$TOOL_TOML"

if [[ ${#COMMANDS[@]} -eq 0 ]]; then
  echo "Warning: No commands found in $TOOL_TOML" >&2
fi

# Generate registry.wit
cat > "$OUT_WIT" << EOF
package ${PACKAGE_WIT}-registry@${VERSION:-0.1.0};

use fw:cli/types@1.0.0;
use fw:cli/command@1.0.0;
use fw:cli/registry@1.0.0;

world registry {
EOF

for cmd in "${COMMANDS[@]}"; do
  echo "  import $cmd: command;" >> "$OUT_WIT"
done

cat >> "$OUT_WIT" << EOF

  export registry;
}
EOF

echo "Generated: $OUT_WIT"

# registry.wasm の生成
# 実際には wit-bindgen + cargo build が必要
# ここではスタブとして wasm-tools を使った最小コンポーネントを生成
if command -v wasm-tools &> /dev/null; then
  echo "Note: Full registry.wasm implementation requires wit-bindgen + Rust build"
  echo "      Creating placeholder component..."
  # プレースホルダーとして空のコンポーネントを作成
  # 実運用では Rust 実装が必要
  touch "$OUT_WASM"
  echo "Created placeholder: $OUT_WASM"
else
  echo "Note: wasm-tools not found. Skipping registry.wasm generation."
  echo "      Install: cargo install wasm-tools"
fi

echo ""
echo "Next steps:"
echo "  1. Implement registry component in Rust using wit-bindgen"
echo "  2. Build with: cargo component build --release"
echo "  3. Copy output to: $OUT_WASM"
