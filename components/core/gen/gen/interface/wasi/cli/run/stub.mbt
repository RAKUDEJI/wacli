// Generated by `wit-bindgen` 0.51.0.

///|
/// Run the program.
pub fn run() -> Result[Unit, Unit] {
  let args = @host.args()

  // Need at least program name + subcommand
  if args.length() < 2 {
    show_help()
    return Ok(())
  }

  let cmd_name = args[1]

  // Handle built-in flags
  if cmd_name == "--help" || cmd_name == "-h" {
    show_help()
    return Ok(())
  }

  if cmd_name == "--version" || cmd_name == "-V" {
    show_version()
    return Ok(())
  }

  // Get subcommand arguments (skip program name and subcommand)
  let cmd_args : Array[String] = []
  for i = 2; i < args.length(); i = i + 1 {
    cmd_args.push(args[i])
  }

  // Run the command via registry
  match @registry.run(cmd_name, cmd_args) {
    Ok(exit_code) => {
      if exit_code == 0 {
        Ok(())
      } else {
        @host.exit(exit_code)
        Err(())
      }
    }
    Err(err) => {
      match err {
        @types.CommandError::UnknownCommand(name) => {
          write_stderr("Error: unknown command '\{name}'\n")
          show_help()
        }
        @types.CommandError::InvalidArgs(msg) => {
          write_stderr("Error: \{msg}\n")
        }
        @types.CommandError::Failed(msg) => {
          write_stderr("Error: \{msg}\n")
        }
      }
      Err(())
    }
  }
}

fn show_help() -> Unit {
  let commands = @registry.list_commands()

  let mut help = "Usage: <program> <command> [args...]\n\nCommands:\n"

  for i = 0; i < commands.length(); i = i + 1 {
    let cmd = commands[i]
    if not(cmd.hidden) {
      help = help + "  \{cmd.name}\t\{cmd.summary}\n"
    }
  }

  help = help + "\nUse '<program> <command> --help' for more information.\n"
  write_stdout(help)
}

fn show_version() -> Unit {
  write_stdout("fw-cli-core 1.0.0\n")
}

fn write_stdout(msg : String) -> Unit {
  let bytes = @encoding/utf8.encode(msg)
  let fixed : FixedArray[Byte] = FixedArray::makei(bytes.length(), fn(i) { bytes[i] })
  @host.stdout_write(fixed)
}

fn write_stderr(msg : String) -> Unit {
  let bytes = @encoding/utf8.encode(msg)
  let fixed : FixedArray[Byte] = FixedArray::makei(bytes.length(), fn(i) { bytes[i] })
  @host.stderr_write(fixed)
}

